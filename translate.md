# mpquic草案-中文版本

当前版本：draft-lmbdhk-quic-multipath-01



## 基本设计原则

1. 尽量重用QUIC-V1的机制，比如path-validation

2. 和QUIC-V1的包头设计格式保持一样，防止被中间件不识别丢掉

3. 拥塞控制必须是路径级别的，每条路径都需要rtt估计

    除了在地址验证之前施加的发送限制之外，服务器还受到拥塞控制器设置的限制的限制。客户端仅受拥塞控制器的约束。

    发生迁移（路径发送变化，除了只有端口号变化的情况，因为此时一般是NAT重绑或中间件引起的），新路径端点需要重置拥塞控制和rtt估计，旧路径发送的数据包的确认帧不能对新路径的拥塞产生影响

    迁移过程中可能会同时使用多条路径，但单个拥塞控制上下文和丢失恢复上下文可能就足够了，即端点可能延迟切换到新的拥塞上下文，知道确认不再使用旧路径

    发送方要对探测包进行例外处理，防止探测包导致拥塞降低

    仅包含ACK帧的数据包不受拥塞控制，所以端点不能重复发这种包用来响应接收到的ack_eliciting

    etc -> https://www.rfc-editor.org/rfc/rfc9000#section-9.4-1

4. PMTU发现 也是每条路径单独的

    PMTU发现协议可以**动态发现整条传输路径上各链路的MTU值**，减少由于重传带来的额外流量开销。

5. 一条路径由四元组组成，源ip，目标ip，源端口，目的端口，每个四元组最多可以有一个 连接ID/活动路径，

    ```
    {source IP address, source port number, destination IP address, destination port number}
    ```

[QUIC-TRANSPORT]( https://www.rfc-editor.org/rfc/rfc9000#section-9.4-1) 的第 9 节中指定的路径管理实现了多个目标：它指示对等点通过新的首选路径切换发送，并允许对等点释放与旧路径关联的资源。 **多路径需要对该机制进行几处更改**：

1. 允许在多条路径上同时传输非探测帧
2. 即使在另一条路径上接收到非探测帧，也继续使用现有路径。
3. 已放弃路径的删除管理

> https://zhuanlan.zhihu.com/p/311221111
>
> **探测帧（probing frames）**是指：`PATH_CHALLENGE`、`PATH_RESPONSE`、`NEW_CONNECTION_ID` 和 `PADDING` 帧，所有其他帧都是**非探测帧（non-probing frames）**。只包含探测帧的包是**探测包（probing packet）**，而包含任何其他帧的包是**非探测包（non-probing packet）**。



该提议支持对所有路径使用一个包号空间或每条路径使用单独的包号空间进行协商。 虽然此版本文档中的规范支持这两种方法，但最终发布 QUIC 多路径扩展的目的是选择一个选项以避免不兼容。 在最终发布之前选择一种方法需要更多的评估和实施经验。 关于利弊的一些讨论可以在这里找到：https://github.com/mirjak/draft-lmbdhk-quic-multipath/blob/master/presentations/PacketNumberSpace_s.pdf



正如当前在这个版本的草案中定义的那样，使用多个数据包编号空间要求连接 ID的使用 是双向的。 今天的部署通常只在从客户端向服务器发送数据包时使用目标连接 ID，因为这解决了最重要的迁移的情况，例如 NAT 重新绑定或移动事件。 需要进一步的讨论和工作来评估当连接 ID 仅存在于一个方向时是否也可以支持使用多个数据包编号空间。



该提案不包括地址发现和管理。假设由多路径QUIC的用户程序来手动处理地址和决定路径的选择和断开 。 此外，本提案仅规定了一个简单的基础的包调度算法，以提供一些基本的实现指导。 然而，更高级的算法以及增强当前路径状态信号的潜在扩展有望作为未来的工作。



## 一些基本概念

1. PathID

    路径标识符，用于在端点处标识 QUIC 连接中的路径。 路径标识符用于多路径控制帧（例如 PATH_ABANDON 帧）来识别路径。 默认情况下，它被定义为用于在该特定路径上发送数据包的目标连接 ID 的序列号，但如果该连接 ID 的长度为零，则可以使用其他定义。

2. PN space ID

    包号空间标识符，用于区分不同路径的包号空间的标识符。它用于 1-RTT 数据包和 ACK_MP 帧。 每个节点都为其提供给对等方的每个 CID 维护一个“已接收数据包”列表，该列表用于确认使用该 CID 接收的数据包。

区别，路径标识符号用于多路径控制帧来确定路径，包号空间标识符用于1-RTT帧和ACK_MP帧来区分不同路径的包计数空间。当使用非0连接ID时，两个标识符的值相等，都是连接ID(Connection ID)的序列数。如果连接ID长度是0，包号空间标识符是0，路径标识符在路径建立的设置。



## 总览

本文档中提出的对 QUIC 的多路径扩展允许同时使用不同的路径来交换单个连接的非探测 QUIC 帧。 这与包含连接迁移机制的基本 QUIC 协议 [QUIC-TRANSPORT] 形成对比，该机制仅选择一个路径来交换此类帧。

多路径 QUIC 连接以 QUIC 握手作为常规 QUIC 连接开始。 进一步参见第 3 节。对等端在握手期间使用 enable_multipath 传输参数来协商多路径功能的使用。 active_connection_id_limit 传输参数限制了连接期间可以使用的最大活动路径数。 因此，多路径 QUIC 连接是已成功协商enable_multipath 传输参数的 QUIC 连接。

要向现有的多路径 QUIC 连接添加新路径，客户端会在所选路径上启动路径验证，如第 4 节中所述。在此版本的文档中，QUIC 服务器不会启动路径的创建， 但它可以验证客户端创建的新路径。 新路径只有在经过验证后才能使用。 每个端将一个路径标识符与每个路径相关联。 当对等方发送 PATH_ABANDON 帧以指示它已关闭其标识符包含在 PATH_ABANDON 帧中的路径时，此标识符特别使用。（这个标识符在PATH_ABANDON帧中使用，要关闭的路径的标识符会包含在这个帧之中，对等方靠发送这个帧来指示路径的关闭。）

除了这些核心功能之外，使用多路径 QUIC 的应用程序通常需要额外的算法来处理活动路径的数量以及它们如何用于发送数据包。 由于这些根据应用程序的要求而有所不同，因此它们的规范超出了本文档的范围。



## 3. 握手协商与传输参数

```
   *  name: enable_multipath (TBD - experiments use 0xbabf)
   *  value: 0 (default) for disabled.
```

定义了以上参数用来 协商是否开启多路径，端在值字段中使用两个bit来协商使用一个包号空间，还是多个包号空间。

```
	   +========+=================================================+
       | Option | Definition                                      |
       +========+=================================================+
       | 0x0    | don't support multipath                         |
       +--------+-------------------------------------------------+
       | 0x1    | only support one PN space for multipath         |
       +--------+-------------------------------------------------+
       | 0x2    | only support multiple PN spaces for multipath   |
       +--------+-------------------------------------------------+
       | 0x3    | support both one PN space and multiple PN space |
       +--------+-------------------------------------------------+
```

对于任何一个端点，参数不存在或设置为 0，或者如果两个端选择不兼容的值，一个提议 0x1，另一个提议 0x2，端必须回退到单路径 [QUIC-TRANSPORT] 并且不得 使用本文档中定义的任何框架或机制。

如果一个端点提议值 0x3，则接受另一个提议的值。 如果两个端点都提议值 0x3，则协商值 0x2。

如果端接收到传输参数“enable_multipath”的值是非期望值，它必须将此视为 MP_CONNECTION_ERROR 类型的连接错误并关闭连接。

扩展不改变[QUIC-TRANSPORT]18.2中的任何定义的参数。

disable_active_migration的定义与 [QUIC-TRANSPORT] 一致，（除了第 18.2 节中的“在客户端对preferred_address 传输参数采取行动之后”），也用来禁用多路径支持。 

activate_connection_id_limit用于限制可用Connection ID的数量，也限制并发路径的数量。QUIC头中没有公开Connection ID，这个限制也是生效的。



## 4. 路径设置和删除

握手之后，两端已经同意开启多路径特性，并且开始开始使用多路径了。 本文档不具体指出 一个可以通过一系列地址到达的端 如何将这一系列的地址告诉别的端。 特别是，如果服务器使用preferred_address传输参数，客户端不应该假设初始服务器地址和包含在此参数中的地址可以同时用于多路径。 此外，本文档不讨论客户端何时决定启动新路径。 我们将此类讨论委托在单独的文件中。

本文增加了一个多路径控制帧，用于路径管理：

```
   *  PATH_ABANDON frame for the receiver side to abandon the path
      Section 12.1
```

所有的新帧用 1-RTT 包发送。

#### 4.1 路径初始化

多路径协商好之后，客户端想要使用额外的路径 必须初始化路径验证程序，通过PATH_CHALLENGE 和 PATH_RESPONSE帧[QUIC-TRANSPORT 第八章]，收到客户端来自新路径的包后，服务端可能使用相同的机制来验证路径。

验证成功之后，客户端就可以在新路径上发送非探测帧，1-RTT的包。**与 [QUIC-TRANSPORT] 的第 9 节中的规范相反，服务器绝不能假设在新路径上接收到非探测数据包表示尝试迁移到该路径。** 相反，服务器应该考虑接收到非探测数据包的新路径可用于传输。

#### 4.2 路径关闭

每个端都管理着可用于传输的路径的集合，连接中的任何时候，每个端都可以决定弃用其中一条路径，比如本地连接的变化或者是设置的更改。当一个端弃用一条路径后，对等端将不会从这条路径上接收非探测包。

想要关闭路径的端不应该依赖于隐式信号，如空闲时间或数据包丢失，而是应该使用显式请求通过发送 PATH_ABANDON 帧来终止路径（参见第 12.1 节）。

##### 4.2.1 使用 PATH_ABANDON 帧关闭路径

客户端和服务端都可以关闭路径，通过发送 PATH_ABANDON帧，该帧使用相应的路径标识符放弃路径。一旦路径被标识为“弃用abandoned”，意味着与这条路径有关的资源，比如使用的连接ID，可以被释放。然而，路径上传输的数据的相关信息不应该被马上释放，因为还会继续收到确认acknowledgments或其他也可能触发在另一条路径上重新传输数据的帧。

当包含 PATH_ABANDON 帧的数据包被确认时，发送 PATH_ABANDON 帧的端点应该认为一条路径已被放弃。 当释放路径的资源时，端应该为路径上使用的连接 ID 发送一个 RETIRE_CONNECTION_ID 帧，如果有的话。

PATH_ABANDON 帧的接收者不应立即释放其资源，而应等待接收到已使用的连接 ID的 RETIRE_CONNECTION_ID 帧或 3 个 RTO 。（but SHOULD wait for the receive of the RETIRE_CONNECTION_ID frame for the used connection IDs or 3 RTOs.）

通常期望客户端使用 PATH_ABANDON 帧向服务器指示路径条件已经改变，如路径不再可用或将不再可用，例如 在移动事件的情况下。 PATH_ABANDON 帧向接收对等方指示发送方不再打算在该路径上发送任何数据包，但也向接收方建议不应在对应方向（either direction）发送数据包。 PATH_ABANDON 帧的接收者也可以发送一个 PATH_ABANDON 帧来表示它自己愿意不再在这条路径上发送任何数据包。

如果使用连接 ID，PATH_ABANDON 帧可以在任何路径上发送，而不仅仅是要关闭的路径。 因此，即使该路径上的连通性已经中断，也可以放弃该路径。 如果没有使用连接 ID，并且必须在打算关闭的路径上发送 PATH_ABANDON 帧，则可能无法再接收包含 PATH_ABANDON 帧的数据包或包含 PATH_ABANDON 帧的 ACK 的数据包，并且端可能需要依靠空闲超时来关闭路径，如第 4.2.3 节所述。

以前在废弃路径上发送并被认为丢失的 可重传帧 应该在不同的路径上重传。

如果 QUIC 连接的唯一活动路径收到 PATH_ABANDON 帧，则接收对等方应该发送 CONNECTION_CLOSE 帧并进入关闭状态。 如果客户端收到最后开放的路径的 PATH_ABANDON 帧，它可能会尝试打开新路径（如果可用），并且仅在路径验证失败或从服务器接收到 CONNECTION_CLOSE 帧时才启动连接关闭。 类似地，如果在发送 CONNECTION_CLOSE 帧之前在新路径上接收到路径探测数据包，服务器可以等待一个短的、有限的时间，例如一个 RTO。





https://datatracker.ietf.org/doc/html/draft-ietf-quic-multipath-01#page-3















